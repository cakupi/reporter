// Cakupi - An open-source, self-hostable code coverage platform
// Copyright (C) 2023  Reinaldy Rafli <aldy505@proton.me>
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU Affero General Public License as published
// by the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU Affero General Public License for more details.
//
// You should have received a copy of the GNU Affero General Public License
// along with this program.  If not, see <https://www.gnu.org/licenses/>.

package lcov_test

import (
	"strings"
	"testing"

	"coverage-worker/provider/lcov"
)

func TestParse_SingleFile(t *testing.T) {
	var content = strings.NewReader(`TN:
SF:src/index.ts
FN:1,sql
FN:25,sql
FN:28,formatQuestion
FN:35,formatColon
FN:42,formatAtP
FNF:5
FNH:5
FNDA:5,sql
FNDA:5,sql
FNDA:1,formatQuestion
FNDA:1,formatColon
FNDA:1,formatAtP
DA:1,5
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,5
DA:27,5
DA:28,5
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,5
DA:35,5
DA:36,1
DA:37,1
DA:38,1
DA:39,1
DA:40,1
DA:41,5
DA:42,5
DA:43,1
DA:44,1
DA:45,1
DA:46,1
DA:47,1
DA:48,5
DA:49,5
DA:50,5
DA:51,5
DA:52,5
DA:53,5
DA:54,5
DA:55,5
DA:56,5
LF:56
LH:56
BRDA:1,0,0,5
BRDA:25,1,0,5
BRDA:26,2,0,18
BRDA:26,3,0,5
BRDA:26,4,0,13
BRDA:28,5,0,1
BRDA:35,6,0,1
BRDA:42,7,0,1
BRF:8
BRH:8
end_of_record`)

	parsedCoverage, err := (lcov.Parser{}).Parse(content)
	if err != nil {
		t.Errorf("unexpected error: %s", err.Error())
	}

	if parsedCoverage.TotalStatements != 56 {
		t.Errorf("expecting TotalStatements to be 56, instead got %d", parsedCoverage.TotalStatements)
	}

	if parsedCoverage.NumberOfFiles != 1 {
		t.Errorf("expecting NumberOfFiles to be 1, instead got %d", parsedCoverage.NumberOfFiles)
	}

	if parsedCoverage.TotalCoveredStatements != 56 {
		t.Errorf("expecting TotalCoveredStatements to be 56, instead got %d", parsedCoverage.TotalCoveredStatements)
	}
}

func TestParse_MultipleFiles(t *testing.T) {
	var content = strings.NewReader(`TN:
SF:src\index.ts
FN:1,default
FN:69,flourite
FN:138,results.reduce.points
FNF:3
FNH:3
FNDA:272,default
FNDA:272,flourite
FNDA:6599,results.reduce.points
DA:1,272
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,1
DA:35,1
DA:36,1
DA:37,1
DA:38,1
DA:39,1
DA:40,1
DA:41,1
DA:42,1
DA:43,1
DA:44,1
DA:45,1
DA:46,1
DA:47,1
DA:48,1
DA:49,1
DA:50,1
DA:51,1
DA:52,1
DA:53,1
DA:54,1
DA:55,1
DA:56,1
DA:57,1
DA:58,1
DA:59,1
DA:60,1
DA:61,1
DA:62,1
DA:63,1
DA:64,1
DA:65,1
DA:66,1
DA:67,1
DA:68,1
DA:69,272
DA:70,272
DA:71,272
DA:72,272
DA:73,272
DA:74,272
DA:75,272
DA:76,272
DA:77,272
DA:78,272
DA:79,1
DA:80,543
DA:81,55
DA:82,488
DA:83,488
DA:84,272
DA:85,272
DA:86,272
DA:87,272
DA:88,272
DA:89,9
DA:90,6
DA:91,6
DA:92,6
DA:93,6
DA:94,6
DA:95,6
DA:96,3
DA:97,3
DA:98,3
DA:99,9
DA:100,2
DA:101,2
DA:102,2
DA:103,2
DA:104,264
DA:105,264
DA:106,264
DA:107,264
DA:108,264
DA:109,264
DA:110,264
DA:111,272
DA:112,6336
DA:113,6336
DA:114,6336
DA:115,6336
DA:116,180144
DA:117,180144
DA:118,12384
DA:119,167760
DA:120,167760
DA:121,180144
DA:122,142536
DA:123,142536
DA:124,142536
DA:125,25224
DA:126,25224
DA:127,25224
DA:128,180144
DA:129,180144
DA:130,180144
DA:131,180144
DA:132,6336
DA:133,6336
DA:134,272
DA:135,263
DA:136,264
DA:137,264
DA:138,264
DA:139,264
DA:140,264
DA:141,272
DA:142,6599
DA:143,264
DA:144,264
DA:145,264
DA:146,272
DA:147,272
DA:148,272
DA:149,1
DA:150,1
DA:151,1
DA:152,1
DA:153,1
LF:153
LH:153
BRDA:1,0,0,272
BRDA:69,1,0,272
BRDA:78,2,0,267
BRDA:78,3,0,1
BRDA:88,4,0,9
BRDA:89,5,0,6
BRDA:91,6,0,3
BRDA:93,7,0,1
BRDA:93,8,0,5
BRDA:95,9,0,3
BRDA:99,10,0,2
BRDA:101,11,0,1
BRDA:101,12,0,1
BRDA:103,13,0,264
BRDA:111,14,0,6336
BRDA:115,15,0,180144
BRDA:117,16,0,12384
BRDA:118,17,0,167760
BRDA:121,18,0,142536
BRDA:124,19,0,25224
BRDA:134,20,0,263
BRDA:135,21,0,264
BRDA:141,22,0,6599
BRDA:142,23,0,264
BRDA:146,24,0,3
BRDA:146,25,0,261
BRDA:79,26,0,543
BRDA:80,27,0,55
BRDA:81,28,0,488
BRDA:108,29,0,6336
BRDA:124,30,0,2215247
BRDA:138,31,0,6599
BRDA:138,32,0,6145
BRDA:138,33,0,454
BRF:34
BRH:34
end_of_record
TN:
SF:src\points.ts
FN:1,getPoints
FN:1,nearTop
FN:3,parsePoint
FN:44,getPoints
FN:59,nearTop
FNF:5
FNH:5
FNDA:167760,getPoints
FNDA:168303,nearTop
FNDA:16696,parsePoint
FNDA:167760,getPoints
FNDA:168303,nearTop
DA:1,168303
DA:2,1
DA:3,16696
DA:4,16696
DA:5,386
DA:6,541
DA:7,596
DA:8,596
DA:9,215
DA:10,301
DA:11,301
DA:12,733
DA:13,742
DA:14,742
DA:15,744
DA:16,768
DA:17,1019
DA:18,2228
DA:19,2228
DA:20,13
DA:21,2553
DA:22,2755
DA:23,4847
DA:24,4924
DA:25,7105
DA:26,7105
DA:27,1
DA:28,97
DA:29,97
DA:30,1194
DA:31,1194
DA:32,5272
DA:33,5272
DA:34,5272
DA:35,1
DA:36,1
DA:37,1
DA:38,1
DA:39,1
DA:40,1
DA:41,1
DA:42,1
DA:43,1
DA:44,1
DA:45,167760
DA:46,2476612
DA:47,2459916
DA:48,167760
DA:49,167760
DA:50,167760
DA:51,1
DA:52,1
DA:53,1
DA:54,1
DA:55,1
DA:56,1
DA:57,1
DA:58,1
DA:59,1
DA:60,168303
DA:61,7968
DA:62,160335
DA:63,160335
DA:64,1
LF:64
LH:64
BRDA:1,0,0,167760
BRDA:1,1,0,168303
BRDA:3,2,0,16696
BRDA:4,3,0,386
BRDA:5,4,0,541
BRDA:6,5,0,596
BRDA:8,6,0,215
BRDA:9,7,0,301
BRDA:11,8,0,733
BRDA:12,9,0,742
BRDA:13,10,0,742
BRDA:14,11,0,744
BRDA:15,12,0,768
BRDA:16,13,0,1019
BRDA:17,14,0,2228
BRDA:19,15,0,13
BRDA:20,16,0,2553
BRDA:21,17,0,2755
BRDA:22,18,0,4847
BRDA:23,19,0,4924
BRDA:24,20,0,7105
BRDA:26,21,0,1
BRDA:27,22,0,97
BRDA:28,23,0,97
BRDA:29,24,0,1194
BRDA:31,25,0,5272
BRDA:32,26,0,5272
BRDA:44,27,0,167760
BRDA:45,28,0,2476612
BRDA:46,29,0,16696
BRDA:46,30,0,2459916
BRDA:49,31,0,2476612
BRDA:59,32,0,168303
BRDA:60,33,0,7968
BRDA:61,34,0,160335
BRF:35
BRH:35
end_of_record
TN:
SF:src\shebang.ts
FN:1,shebangMap
FNF:1
FNH:1
FNDA:6,shebangMap
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
LF:9
LH:9
BRDA:1,0,0,6
BRF:1
BRH:1
end_of_record
TN:
SF:src\shiki.ts
FN:1,convert
FN:8,convert
FNF:2
FNH:2
FNDA:4,convert
FNDA:4,convert
DA:1,4
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,4
DA:10,4
DA:11,2
DA:12,1
LF:12
LH:12
BRDA:1,0,0,4
BRDA:8,1,0,4
BRDA:9,2,0,1
BRDA:9,3,0,3
BRDA:10,4,0,1
BRDA:10,5,0,2
BRF:6
BRH:6
end_of_record
TN:
SF:src\languages\c.ts
FN:1,C
FNF:1
FNH:1
FNDA:1,C
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,1
DA:35,1
DA:36,1
DA:37,1
DA:38,1
DA:39,1
DA:40,1
DA:41,1
DA:42,1
DA:43,1
DA:44,1
DA:45,1
DA:46,1
DA:47,1
DA:48,1
DA:49,1
DA:50,1
DA:51,1
DA:52,1
DA:53,1
LF:53
LH:53
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\clojure.ts
FN:1,Clojure
FNF:1
FNH:1
FNDA:1,Clojure
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
LF:16
LH:16
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\cpp.ts
FN:1,CPP
FNF:1
FNH:1
FNDA:1,CPP
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,1
DA:35,1
DA:36,1
DA:37,1
DA:38,1
DA:39,1
DA:40,1
DA:41,1
DA:42,1
DA:43,1
DA:44,1
DA:45,1
DA:46,1
DA:47,1
DA:48,1
DA:49,1
DA:50,1
DA:51,1
DA:52,1
DA:53,1
DA:54,1
DA:55,1
DA:56,1
DA:57,1
DA:58,1
LF:58
LH:58
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\cs.ts
FN:1,CS
FNF:1
FNH:1
FNDA:1,CS
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,1
DA:35,1
DA:36,1
DA:37,1
DA:38,1
DA:39,1
DA:40,1
DA:41,1
DA:42,1
DA:43,1
DA:44,1
LF:44
LH:44
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\css.ts
FN:1,CSS
FNF:1
FNH:1
FNDA:1,CSS
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
LF:8
LH:8
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\dart.ts
FN:1,Dart
FNF:1
FNH:1
FNDA:1,Dart
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,1
DA:35,1
DA:36,1
DA:37,1
DA:38,1
DA:39,1
DA:40,1
DA:41,1
DA:42,1
DA:43,1
DA:44,1
LF:44
LH:44
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\dockerfile.ts
FN:1,Dockerfile
FNF:1
FNH:1
FNDA:1,Dockerfile
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
LF:30
LH:30
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\elixir.ts
FN:1,Elixir
FNF:1
FNH:1
FNDA:1,Elixir
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
LF:21
LH:21
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\go.ts
FN:1,Go
FNF:1
FNH:1
FNDA:1,Go
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
LF:30
LH:30
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\html.ts
FN:1,HTML
FNF:1
FNH:1
FNDA:1,HTML
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
LF:13
LH:13
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\java.ts
FN:1,Java
FNF:1
FNH:1
FNDA:1,Java
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,1
DA:35,1
DA:36,1
DA:37,1
DA:38,1
DA:39,1
DA:40,1
DA:41,1
DA:42,1
DA:43,1
DA:44,1
DA:45,1
DA:46,1
DA:47,1
DA:48,1
DA:49,1
DA:50,1
DA:51,1
DA:52,1
DA:53,1
DA:54,1
DA:55,1
DA:56,1
DA:57,1
DA:58,1
LF:58
LH:58
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\javascript.ts
FN:1,Javascript
FNF:1
FNH:1
FNDA:1,Javascript
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,1
DA:35,1
DA:36,1
DA:37,1
DA:38,1
DA:39,1
DA:40,1
DA:41,1
DA:42,1
DA:43,1
DA:44,1
DA:45,1
DA:46,1
DA:47,1
DA:48,1
DA:49,1
DA:50,1
LF:50
LH:50
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\json.ts
FN:1,JSON
FNF:1
FNH:1
FNDA:1,JSON
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
LF:16
LH:16
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\julia.ts
FN:1,Julia
FNF:1
FNH:1
FNDA:1,Julia
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,1
DA:35,1
DA:36,1
DA:37,1
DA:38,1
LF:38
LH:38
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\kotlin.ts
FN:1,Kotlin
FNF:1
FNH:1
FNDA:1,Kotlin
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
LF:21
LH:21
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\lua.ts
FN:1,Lua
FNF:1
FNH:1
FNDA:1,Lua
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,1
DA:35,1
DA:36,1
DA:37,1
DA:38,1
DA:39,1
DA:40,1
DA:41,1
DA:42,1
DA:43,1
DA:44,1
DA:45,1
DA:46,1
DA:47,1
DA:48,1
DA:49,1
DA:50,1
DA:51,1
DA:52,1
DA:53,1
DA:54,1
DA:55,1
DA:56,1
DA:57,1
DA:58,1
DA:59,1
DA:60,1
DA:61,1
DA:62,1
DA:63,1
DA:64,1
DA:65,1
DA:66,1
DA:67,1
DA:68,1
DA:69,1
LF:69
LH:69
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\markdown.ts
FN:1,Markdown
FNF:1
FNH:1
FNDA:1,Markdown
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
LF:20
LH:20
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\pascal.ts
FN:1,Pascal
FNF:1
FNH:1
FNDA:1,Pascal
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
LF:19
LH:19
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\php.ts
FN:1,PHP
FNF:1
FNH:1
FNDA:1,PHP
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,1
DA:35,1
DA:36,1
LF:36
LH:36
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\python.ts
FN:1,Python
FNF:1
FNH:1
FNDA:1,Python
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,1
DA:35,1
LF:35
LH:35
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\ruby.ts
FN:1,Ruby
FNF:1
FNH:1
FNDA:1,Ruby
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,1
DA:35,1
LF:35
LH:35
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\rust.ts
FN:1,Rust
FNF:1
FNH:1
FNDA:1,Rust
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
LF:28
LH:28
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\sql.ts
FN:1,SQL
FNF:1
FNH:1
FNDA:1,SQL
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
LF:27
LH:27
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
TN:
SF:src\languages\yaml.ts
FN:1,YAML
FNF:1
FNH:1
FNDA:1,YAML
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
LF:25
LH:25
BRDA:1,0,0,1
BRF:1
BRH:1
end_of_record
`)

	parsedCoverage, err := (lcov.Parser{}).Parse(content)
	if err != nil {
		t.Errorf("unexpected error: %s", err.Error())
	}

	if parsedCoverage.TotalStatements != 1032 {
		t.Errorf("expecting TotalStatements to be 1032, instead got %d", parsedCoverage.TotalStatements)
	}

	if parsedCoverage.NumberOfFiles != 28 {
		t.Errorf("expecting NumberOfFiles to be 28, instead got %d", parsedCoverage.NumberOfFiles)
	}

	if parsedCoverage.TotalCoveredStatements != 1032 {
		t.Errorf("expecting TotalCoveredStatements to be 1032, instead got %d", parsedCoverage.TotalCoveredStatements)
	}
}

func TestParse_NotCovered(t *testing.T) {
	var content = strings.NewReader(`TN:
SF:src/job/files.ts
FN:9,Files
FNF:1
FNH:1
FNDA:7,Files
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,7
DA:11,7
DA:12,7
DA:13,13
DA:14,13
DA:15,3
DA:16,10
DA:17,10
DA:18,10
DA:19,13
DA:20,7
DA:21,1
LF:21
LH:21
BRDA:9,0,0,7
BRDA:12,1,0,13
BRDA:14,2,0,10
BRDA:14,3,0,3
BRF:4
BRH:4
end_of_record
TN:
SF:src/job/job.ts
FN:34,Job
FN:79,createFile
FN:101,compile
FN:140,run
FN:181,cleanup
FN:193,executeCommand
FNF:6
FNH:5
FNDA:6,Job
FNDA:3,createFile
FNDA:0,compile
FNDA:2,run
FNDA:2,cleanup
FNDA:2,executeCommand
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,1
DA:12,1
DA:13,1
DA:14,1
DA:15,1
DA:16,1
DA:17,1
DA:18,1
DA:19,1
DA:20,1
DA:21,1
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,1
DA:27,1
DA:28,1
DA:29,1
DA:30,1
DA:31,1
DA:32,1
DA:33,1
DA:34,1
DA:35,6
DA:36,6
DA:37,6
DA:38,6
DA:39,6
DA:40,6
DA:41,6
DA:42,6
DA:43,6
DA:44,6
DA:45,6
DA:46,6
DA:47,6
DA:48,1
DA:49,1
DA:50,6
DA:51,6
DA:52,3
DA:53,6
DA:54,2
DA:55,2
DA:56,6
DA:57,6
DA:58,3
DA:59,6
DA:60,2
DA:61,2
DA:62,6
DA:63,6
DA:64,6
DA:65,6
DA:66,3
DA:67,6
DA:68,3
DA:69,6
DA:70,2
DA:71,2
DA:72,5
DA:73,5
DA:74,5
DA:75,5
DA:76,5
DA:77,5
DA:78,1
DA:79,1
DA:80,3
DA:81,3
DA:82,3
DA:83,5
DA:84,5
DA:85,5
DA:86,5
DA:87,5
DA:88,5
DA:89,5
DA:90,5
DA:91,5
DA:92,5
DA:93,5
DA:94,3
DA:95,3
DA:96,5
DA:97,5
DA:98,5
DA:99,3
DA:100,1
DA:101,1
DA:102,0
DA:103,0
DA:104,0
DA:105,0
DA:106,0
DA:107,0
DA:108,0
DA:109,0
DA:110,0
DA:111,0
DA:112,0
DA:113,0
DA:114,0
DA:115,0
DA:116,0
DA:117,0
DA:118,0
DA:119,0
DA:120,0
DA:121,0
DA:122,0
DA:123,0
DA:124,0
DA:125,0
DA:126,0
DA:127,0
DA:128,0
DA:129,0
DA:130,0
DA:131,0
DA:132,0
DA:133,0
DA:134,0
DA:135,0
DA:136,0
DA:137,0
DA:138,0
DA:139,1
DA:140,1
DA:141,2
DA:142,2
DA:143,2
DA:144,2
DA:145,2
DA:146,0
DA:147,0
DA:148,2
DA:149,2
DA:150,2
DA:151,2
DA:152,2
DA:153,2
DA:154,2
DA:155,2
DA:156,2
DA:157,2
DA:158,2
DA:159,2
DA:160,2
DA:161,2
DA:162,2
DA:163,2
DA:164,2
DA:165,2
DA:166,2
DA:167,2
DA:168,4
DA:169,2
DA:170,2
DA:171,2
DA:172,2
DA:173,2
DA:174,2
DA:175,2
DA:176,0
DA:177,0
DA:178,0
DA:179,2
DA:180,1
DA:181,1
DA:182,2
DA:183,2
DA:184,2
DA:185,2
DA:186,4
DA:187,2
DA:188,2
DA:189,2
DA:190,2
DA:191,2
DA:192,1
DA:193,1
DA:194,2
DA:195,2
DA:196,2
DA:197,2
DA:198,2
DA:199,2
DA:200,2
DA:201,2
DA:202,2
DA:203,2
DA:204,2
DA:205,2
DA:206,2
DA:207,2
DA:208,2
DA:209,2
DA:210,2
DA:211,2
DA:212,2
DA:213,2
DA:214,2
DA:215,2
DA:216,2
DA:217,2
DA:218,2
DA:219,2
DA:220,2
DA:221,0
DA:222,0
DA:223,0
DA:224,0
DA:225,0
DA:226,0
DA:227,2
DA:228,2
DA:229,2
DA:230,20
DA:231,20
DA:232,20
DA:233,20
DA:234,0
DA:235,0
DA:236,2
DA:237,2
DA:238,2
DA:239,0
DA:240,0
DA:241,0
DA:242,0
DA:243,2
DA:244,2
DA:245,2
DA:246,2
DA:247,2
DA:248,2
DA:249,2
DA:250,2
DA:251,2
DA:252,2
DA:253,2
DA:254,2
DA:255,2
DA:256,2
DA:257,2
DA:258,2
DA:259,2
DA:260,2
DA:261,2
DA:262,1
LF:262
LH:208
BRDA:34,0,0,6
BRDA:47,1,0,1
BRDA:51,2,0,3
BRDA:51,3,0,3
BRDA:51,4,0,3
BRDA:53,5,0,2
BRDA:57,6,0,3
BRDA:57,7,0,3
BRDA:57,8,0,3
BRDA:59,9,0,2
BRDA:64,10,0,3
BRDA:65,11,0,3
BRDA:67,12,0,3
BRDA:69,13,0,2
BRDA:72,14,0,5
BRDA:79,15,0,3
BRDA:82,16,0,5
BRDA:93,17,0,3
BRDA:140,18,0,2
BRDA:145,19,0,0
BRDA:175,20,0,0
BRDA:167,21,0,4
BRDA:181,22,0,2
BRDA:185,23,0,4
BRDA:193,24,0,2
BRDA:197,25,0,2
BRDA:206,26,0,0
BRDA:215,27,0,0
BRDA:229,28,0,20
BRDA:233,29,0,0
BRDA:245,30,0,2
BRDA:250,31,0,0
BRF:32
BRH:26
end_of_record
TN:
SF:src/runtime/runtime.ts
FN:2,Runtime
FN:36,markAsLatest
FNF:2
FNH:2
FNDA:18,Runtime
FNDA:2,markAsLatest
DA:1,1
DA:2,1
DA:3,18
DA:4,18
DA:5,18
DA:6,18
DA:7,18
DA:8,18
DA:9,18
DA:10,18
DA:11,18
DA:12,18
DA:13,18
DA:14,18
DA:15,18
DA:16,18
DA:17,18
DA:18,1
DA:19,1
DA:20,18
DA:21,18
DA:22,1
DA:23,1
DA:24,1
DA:25,1
DA:26,16
DA:27,18
DA:28,1
DA:29,1
DA:30,18
DA:31,18
DA:32,1
DA:33,1
DA:34,18
DA:35,1
DA:36,1
DA:37,2
DA:38,2
DA:39,1
LF:39
LH:39
BRDA:2,0,0,18
BRDA:17,1,0,17
BRDA:17,2,0,17
BRDA:17,3,0,17
BRDA:17,4,0,17
BRDA:17,5,0,17
BRDA:17,6,0,17
BRDA:17,7,0,17
BRDA:17,8,0,1
BRDA:21,9,0,6
BRDA:21,10,0,1
BRDA:26,11,0,16
BRDA:27,12,0,8
BRDA:27,13,0,1
BRDA:31,14,0,1
BRDA:36,15,0,2
BRF:16
BRH:16
end_of_record
TN:
SF:src/user/user.ts
FN:10,SystemUsers
FN:26,acquire
FN:36,release
FNF:3
FNH:3
FNDA:4,SystemUsers
FNDA:6,acquire
FNDA:1,release
DA:1,1
DA:2,1
DA:3,1
DA:4,1
DA:5,1
DA:6,1
DA:7,1
DA:8,1
DA:9,1
DA:10,1
DA:11,4
DA:12,1
DA:13,1
DA:14,3
DA:15,3
DA:16,4
DA:17,14
DA:18,14
DA:19,14
DA:20,14
DA:21,14
DA:22,14
DA:23,14
DA:24,4
DA:25,1
DA:26,1
DA:27,6
DA:28,6
DA:29,5
DA:30,5
DA:31,5
DA:32,5
DA:33,1
DA:34,1
DA:35,1
DA:36,1
DA:37,1
DA:38,1
DA:39,1
DA:40,1
DA:41,1
DA:42,1
LF:42
LH:42
BRDA:10,0,0,4
BRDA:11,1,0,1
BRDA:14,2,0,3
BRDA:16,3,0,14
BRDA:26,4,0,6
BRDA:28,5,0,5
BRDA:33,6,0,1
BRDA:27,7,0,9
BRDA:36,8,0,1
BRDA:37,9,0,1
BRF:10
BRH:10
end_of_record`)

	parsedCoverage, err := (lcov.Parser{}).Parse(content)
	if err != nil {
		t.Errorf("unexpected error: %s", err.Error())
	}

	if parsedCoverage.TotalStatements != 364 {
		t.Errorf("expecting TotalStatements to be 364, instead got %d", parsedCoverage.TotalStatements)
	}

	if parsedCoverage.NumberOfFiles != 4 {
		t.Errorf("expecting NumberOfFiles to be 4, instead got %d", parsedCoverage.NumberOfFiles)
	}

	if parsedCoverage.TotalCoveredStatements != 310 {
		t.Errorf("expecting TotalCoveredStatements to be 310, instead got %d", parsedCoverage.TotalCoveredStatements)
	}
}
